(function(){var i=require("fs"),e=require("child_process").exec,b,a="./uploads/",h=require("./download"),g=function(){};exports.download=h.download;exports.compress=function(l){g=l.callback;switch(l.type){case 0:f(l.text,l.filetype||"js",function(m){console.log(m);d(m.path,m.filename,m.filetype)});break;case 1:if(Object.prototype.toString.call(l.files)!=="[object Array]"){l.files=[l.files]}for(var k in l.files){var j={};j.path="./"+l.files[k].path;j.filename=j.path.substring(j.path.lastIndexOf("/")+1);j.filetype=l.files[k].name.substring(l.files[k].name.lastIndexOf(".")+1);i.rename(j.path,j.path+"."+j.filetype,function(m){if(m){throw m}j.path+="."+j.filetype;d(j.path,j.filename,j.filetype)})}break;case 2:c(l.url,function(m){console.log(m);d(m.path,m.filename,m.filetype)});break;default:console.log("unknown type!")}};function f(m,k,n){var j=+new Date(),l=a+j+"."+k;i.writeFile(l,m,function(o){if(o){throw o}n({filename:j,path:l,filetype:k})})}function c(l,p){if(!l){return}var j=l.substring(l.lastIndexOf("/")+1),m=j.substring(j.lastIndexOf(".")+1),k=+new Date(),n=a+k+"."+m,o="curl "+l+" -o "+n;console.log(o);b=e(o,function(s,q,r){if(s!==null){console.log("exec error: "+s)}else{console.log("curl",n);p({path:n,filetype:m,filename:k})}})}function d(l,j,k){var m="java -jar ./tools/yuicompressor-2.4.7.jar -o  ./tmp/"+j+".min."+k+" "+l;console.log(m);b=e(m,function(p,n,o){if(p!==null){console.log("exec error:"+p)}else{console.log("compress success");i.unlink(l,function(s){if(s){throw s}console.log("successfully deleted "+l)})}var q="./tmp/"+j+".min."+k;var r=i.statSync(l).size;resultSize=i.statSync(q).size;g({retcode:0,path:j+".min.js",originSize:r,resultSize:resultSize})})}})();