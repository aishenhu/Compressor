(function(){var b=require("fs"),c=require("child_process").exec,h,g="./uploads/",d=function(){};exports.compress=function(l){d=l.callback;switch(l.type){case 0:f(l.text,l.filetype||"js",function(i){console.log(i);a(i.path,i.filename,i.filetype)});break;case 1:if(Object.prototype.toString.call(l.files)!=="[object Array]"){l.files=[l.files]}for(var k in l.files){var j={};j.path="./"+l.files[k].path;j.filename=j.path.substring(j.path.lastIndexOf("/")+1);j.filetype=l.files[k].name.substring(l.files[k].name.lastIndexOf(".")+1);b.rename(j.path,j.path+"."+j.filetype,function(i){if(i){throw i}j.path+="."+j.filetype;a(j.path,j.filename,j.filetype)})}break;case 2:e(l.url,function(i){console.log(i);a(i.path,i.filename,i.filetype)});break;default:console.log("unknown type!")}};function f(l,j,m){var i=+new Date(),k=g+i+"."+j;b.writeFile(k,l,function(n){if(n){throw n}m({filename:i,path:k,filetype:j})})}function e(k,o){if(!k){return}var i=k.substring(k.lastIndexOf("/")+1),l=i.substring(i.lastIndexOf(".")+1),j=+new Date(),m=g+j+"."+l,n="curl "+k+" -o "+m;console.log(n);h=c(n,function(r,p,q){if(r!==null){console.log("exec error: "+r)}else{console.log("curl",m);o({path:m,filetype:l,filename:j})}})}function a(k,i,j){var l="java -jar ./tools/yuicompressor-2.4.7.jar -o  ./tmp/"+i+".min."+j+" "+k;console.log(l);h=c(l,function(o,m,n){if(o!==null){console.log("exec error:"+o)}else{console.log("compress success");b.unlink(k,function(r){if(r){throw r}console.log("successfully deleted "+k)})}var p="./tmp/"+i+".min."+j;var q=b.statSync(k).size;resultSize=b.statSync(p).size;d({retcode:0,path:p,originSize:q,resultSize:resultSize})})}})();